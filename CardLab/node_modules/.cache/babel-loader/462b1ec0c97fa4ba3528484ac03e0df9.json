{"ast":null,"code":"\"use strict\"; // The MIT License (MIT)\n//\n// Copyright (c) 2017 Firebase\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in all\n// copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n// SOFTWARE.\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.DocumentBuilder = exports.beforeSnapshotConstructor = exports.snapshotConstructor = exports.NamespaceBuilder = exports.DatabaseBuilder = exports._documentWithOptions = exports._namespaceWithOptions = exports._databaseWithOptions = exports.database = exports.namespace = exports.document = exports.defaultDatabase = exports.service = exports.provider = void 0;\n\nconst firebase = require(\"firebase-admin\");\n\nconst _ = require(\"lodash\");\n\nconst path_1 = require(\"path\");\n\nconst apps_1 = require(\"../apps\");\n\nconst cloud_functions_1 = require(\"../cloud-functions\");\n\nconst encoder_1 = require(\"../encoder\");\n/** @hidden */\n\n\nexports.provider = 'google.firestore';\n/** @hidden */\n\nexports.service = 'firestore.googleapis.com';\n/** @hidden */\n\nexports.defaultDatabase = '(default)';\nlet firestoreInstance;\n/**\n * Select the Firestore document to listen to for events.\n * @param path Full database path to listen to. This includes the name of\n * the collection that the document is a part of. For example, if the\n * collection is named \"users\" and the document is named \"Ada\", then the\n * path is \"/users/Ada\".\n */\n\nfunction document(path) {\n  return _documentWithOptions(path, {});\n}\n\nexports.document = document;\n/** @hidden */\n// Multiple namespaces are not yet supported by Firestore.\n\nfunction namespace(namespace) {\n  return _namespaceWithOptions(namespace, {});\n}\n\nexports.namespace = namespace;\n/** @hidden */\n// Multiple databases are not yet supported by Firestore.\n\nfunction database(database) {\n  return _databaseWithOptions(database, {});\n}\n\nexports.database = database;\n/** @hidden */\n\nfunction _databaseWithOptions(database = exports.defaultDatabase, options) {\n  return new DatabaseBuilder(database, options);\n}\n\nexports._databaseWithOptions = _databaseWithOptions;\n/** @hidden */\n\nfunction _namespaceWithOptions(namespace, options) {\n  return _databaseWithOptions(exports.defaultDatabase, options).namespace(namespace);\n}\n\nexports._namespaceWithOptions = _namespaceWithOptions;\n/** @hidden */\n\nfunction _documentWithOptions(path, options) {\n  return _databaseWithOptions(exports.defaultDatabase, options).document(path);\n}\n\nexports._documentWithOptions = _documentWithOptions;\n\nclass DatabaseBuilder {\n  /** @hidden */\n  constructor(database, options) {\n    this.database = database;\n    this.options = options;\n  }\n\n  namespace(namespace) {\n    return new NamespaceBuilder(this.database, this.options, namespace);\n  }\n\n  document(path) {\n    return new NamespaceBuilder(this.database, this.options).document(path);\n  }\n\n}\n\nexports.DatabaseBuilder = DatabaseBuilder;\n\nclass NamespaceBuilder {\n  /** @hidden */\n  constructor(database, options, namespace) {\n    this.database = database;\n    this.options = options;\n    this.namespace = namespace;\n  }\n\n  document(path) {\n    return new DocumentBuilder(() => {\n      if (!process.env.GCLOUD_PROJECT) {\n        throw new Error('process.env.GCLOUD_PROJECT is not set.');\n      }\n\n      const database = path_1.posix.join('projects', process.env.GCLOUD_PROJECT, 'databases', this.database);\n      return path_1.posix.join(database, this.namespace ? `documents@${this.namespace}` : 'documents', path);\n    }, this.options);\n  }\n\n}\n\nexports.NamespaceBuilder = NamespaceBuilder;\n\nfunction _getValueProto(data, resource, valueFieldName) {\n  if (_.isEmpty(_.get(data, valueFieldName))) {\n    // Firestore#snapshot_ takes resource string instead of proto for a non-existent snapshot\n    return resource;\n  }\n\n  const proto = {\n    fields: _.get(data, [valueFieldName, 'fields'], {}),\n    createTime: encoder_1.dateToTimestampProto(_.get(data, [valueFieldName, 'createTime'])),\n    updateTime: encoder_1.dateToTimestampProto(_.get(data, [valueFieldName, 'updateTime'])),\n    name: _.get(data, [valueFieldName, 'name'], resource)\n  };\n  return proto;\n}\n/** @hidden */\n\n\nfunction snapshotConstructor(event) {\n  if (!firestoreInstance) {\n    firestoreInstance = firebase.firestore(apps_1.apps().admin);\n  }\n\n  const valueProto = _getValueProto(event.data, event.context.resource.name, 'value');\n\n  const readTime = encoder_1.dateToTimestampProto(_.get(event, 'data.value.readTime'));\n  return firestoreInstance.snapshot_(valueProto, readTime, 'json');\n}\n\nexports.snapshotConstructor = snapshotConstructor;\n/** @hidden */\n// TODO remove this function when wire format changes to new format\n\nfunction beforeSnapshotConstructor(event) {\n  if (!firestoreInstance) {\n    firestoreInstance = firebase.firestore(apps_1.apps().admin);\n  }\n\n  const oldValueProto = _getValueProto(event.data, event.context.resource.name, 'oldValue');\n\n  const oldReadTime = encoder_1.dateToTimestampProto(_.get(event, 'data.oldValue.readTime'));\n  return firestoreInstance.snapshot_(oldValueProto, oldReadTime, 'json');\n}\n\nexports.beforeSnapshotConstructor = beforeSnapshotConstructor;\n\nfunction changeConstructor(raw) {\n  return cloud_functions_1.Change.fromObjects(beforeSnapshotConstructor(raw), snapshotConstructor(raw));\n}\n\nclass DocumentBuilder {\n  /** @hidden */\n  constructor(triggerResource, options) {\n    this.triggerResource = triggerResource;\n    this.options = options; // TODO what validation do we want to do here?\n  }\n  /** Respond to all document writes (creates, updates, or deletes). */\n\n\n  onWrite(handler) {\n    return this.onOperation(handler, 'document.write', changeConstructor);\n  }\n  /** Respond only to document updates. */\n\n\n  onUpdate(handler) {\n    return this.onOperation(handler, 'document.update', changeConstructor);\n  }\n  /** Respond only to document creations. */\n\n\n  onCreate(handler) {\n    return this.onOperation(handler, 'document.create', snapshotConstructor);\n  }\n  /** Respond only to document deletions. */\n\n\n  onDelete(handler) {\n    return this.onOperation(handler, 'document.delete', beforeSnapshotConstructor);\n  }\n\n  onOperation(handler, eventType, dataConstructor) {\n    return cloud_functions_1.makeCloudFunction({\n      handler,\n      provider: exports.provider,\n      eventType,\n      service: exports.service,\n      triggerResource: this.triggerResource,\n      legacyEventType: `providers/cloud.firestore/eventTypes/${eventType}`,\n      dataConstructor,\n      options: this.options\n    });\n  }\n\n}\n\nexports.DocumentBuilder = DocumentBuilder;","map":{"version":3,"sources":["/Users/aep/phd/hearth-mici/node_modules/firebase-functions/lib/providers/firestore.js"],"names":["Object","defineProperty","exports","value","DocumentBuilder","beforeSnapshotConstructor","snapshotConstructor","NamespaceBuilder","DatabaseBuilder","_documentWithOptions","_namespaceWithOptions","_databaseWithOptions","database","namespace","document","defaultDatabase","service","provider","firebase","require","_","path_1","apps_1","cloud_functions_1","encoder_1","firestoreInstance","path","options","constructor","process","env","GCLOUD_PROJECT","Error","posix","join","_getValueProto","data","resource","valueFieldName","isEmpty","get","proto","fields","createTime","dateToTimestampProto","updateTime","name","event","firestore","apps","admin","valueProto","context","readTime","snapshot_","oldValueProto","oldReadTime","changeConstructor","raw","Change","fromObjects","triggerResource","onWrite","handler","onOperation","onUpdate","onCreate","onDelete","eventType","dataConstructor","makeCloudFunction","legacyEventType"],"mappings":"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","sourcesContent":["\"use strict\";\n// The MIT License (MIT)\n//\n// Copyright (c) 2017 Firebase\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in all\n// copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n// SOFTWARE.\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.DocumentBuilder = exports.beforeSnapshotConstructor = exports.snapshotConstructor = exports.NamespaceBuilder = exports.DatabaseBuilder = exports._documentWithOptions = exports._namespaceWithOptions = exports._databaseWithOptions = exports.database = exports.namespace = exports.document = exports.defaultDatabase = exports.service = exports.provider = void 0;\nconst firebase = require(\"firebase-admin\");\nconst _ = require(\"lodash\");\nconst path_1 = require(\"path\");\nconst apps_1 = require(\"../apps\");\nconst cloud_functions_1 = require(\"../cloud-functions\");\nconst encoder_1 = require(\"../encoder\");\n/** @hidden */\nexports.provider = 'google.firestore';\n/** @hidden */\nexports.service = 'firestore.googleapis.com';\n/** @hidden */\nexports.defaultDatabase = '(default)';\nlet firestoreInstance;\n/**\n * Select the Firestore document to listen to for events.\n * @param path Full database path to listen to. This includes the name of\n * the collection that the document is a part of. For example, if the\n * collection is named \"users\" and the document is named \"Ada\", then the\n * path is \"/users/Ada\".\n */\nfunction document(path) {\n    return _documentWithOptions(path, {});\n}\nexports.document = document;\n/** @hidden */\n// Multiple namespaces are not yet supported by Firestore.\nfunction namespace(namespace) {\n    return _namespaceWithOptions(namespace, {});\n}\nexports.namespace = namespace;\n/** @hidden */\n// Multiple databases are not yet supported by Firestore.\nfunction database(database) {\n    return _databaseWithOptions(database, {});\n}\nexports.database = database;\n/** @hidden */\nfunction _databaseWithOptions(database = exports.defaultDatabase, options) {\n    return new DatabaseBuilder(database, options);\n}\nexports._databaseWithOptions = _databaseWithOptions;\n/** @hidden */\nfunction _namespaceWithOptions(namespace, options) {\n    return _databaseWithOptions(exports.defaultDatabase, options).namespace(namespace);\n}\nexports._namespaceWithOptions = _namespaceWithOptions;\n/** @hidden */\nfunction _documentWithOptions(path, options) {\n    return _databaseWithOptions(exports.defaultDatabase, options).document(path);\n}\nexports._documentWithOptions = _documentWithOptions;\nclass DatabaseBuilder {\n    /** @hidden */\n    constructor(database, options) {\n        this.database = database;\n        this.options = options;\n    }\n    namespace(namespace) {\n        return new NamespaceBuilder(this.database, this.options, namespace);\n    }\n    document(path) {\n        return new NamespaceBuilder(this.database, this.options).document(path);\n    }\n}\nexports.DatabaseBuilder = DatabaseBuilder;\nclass NamespaceBuilder {\n    /** @hidden */\n    constructor(database, options, namespace) {\n        this.database = database;\n        this.options = options;\n        this.namespace = namespace;\n    }\n    document(path) {\n        return new DocumentBuilder(() => {\n            if (!process.env.GCLOUD_PROJECT) {\n                throw new Error('process.env.GCLOUD_PROJECT is not set.');\n            }\n            const database = path_1.posix.join('projects', process.env.GCLOUD_PROJECT, 'databases', this.database);\n            return path_1.posix.join(database, this.namespace ? `documents@${this.namespace}` : 'documents', path);\n        }, this.options);\n    }\n}\nexports.NamespaceBuilder = NamespaceBuilder;\nfunction _getValueProto(data, resource, valueFieldName) {\n    if (_.isEmpty(_.get(data, valueFieldName))) {\n        // Firestore#snapshot_ takes resource string instead of proto for a non-existent snapshot\n        return resource;\n    }\n    const proto = {\n        fields: _.get(data, [valueFieldName, 'fields'], {}),\n        createTime: encoder_1.dateToTimestampProto(_.get(data, [valueFieldName, 'createTime'])),\n        updateTime: encoder_1.dateToTimestampProto(_.get(data, [valueFieldName, 'updateTime'])),\n        name: _.get(data, [valueFieldName, 'name'], resource),\n    };\n    return proto;\n}\n/** @hidden */\nfunction snapshotConstructor(event) {\n    if (!firestoreInstance) {\n        firestoreInstance = firebase.firestore(apps_1.apps().admin);\n    }\n    const valueProto = _getValueProto(event.data, event.context.resource.name, 'value');\n    const readTime = encoder_1.dateToTimestampProto(_.get(event, 'data.value.readTime'));\n    return firestoreInstance.snapshot_(valueProto, readTime, 'json');\n}\nexports.snapshotConstructor = snapshotConstructor;\n/** @hidden */\n// TODO remove this function when wire format changes to new format\nfunction beforeSnapshotConstructor(event) {\n    if (!firestoreInstance) {\n        firestoreInstance = firebase.firestore(apps_1.apps().admin);\n    }\n    const oldValueProto = _getValueProto(event.data, event.context.resource.name, 'oldValue');\n    const oldReadTime = encoder_1.dateToTimestampProto(_.get(event, 'data.oldValue.readTime'));\n    return firestoreInstance.snapshot_(oldValueProto, oldReadTime, 'json');\n}\nexports.beforeSnapshotConstructor = beforeSnapshotConstructor;\nfunction changeConstructor(raw) {\n    return cloud_functions_1.Change.fromObjects(beforeSnapshotConstructor(raw), snapshotConstructor(raw));\n}\nclass DocumentBuilder {\n    /** @hidden */\n    constructor(triggerResource, options) {\n        this.triggerResource = triggerResource;\n        this.options = options;\n        // TODO what validation do we want to do here?\n    }\n    /** Respond to all document writes (creates, updates, or deletes). */\n    onWrite(handler) {\n        return this.onOperation(handler, 'document.write', changeConstructor);\n    }\n    /** Respond only to document updates. */\n    onUpdate(handler) {\n        return this.onOperation(handler, 'document.update', changeConstructor);\n    }\n    /** Respond only to document creations. */\n    onCreate(handler) {\n        return this.onOperation(handler, 'document.create', snapshotConstructor);\n    }\n    /** Respond only to document deletions. */\n    onDelete(handler) {\n        return this.onOperation(handler, 'document.delete', beforeSnapshotConstructor);\n    }\n    onOperation(handler, eventType, dataConstructor) {\n        return cloud_functions_1.makeCloudFunction({\n            handler,\n            provider: exports.provider,\n            eventType,\n            service: exports.service,\n            triggerResource: this.triggerResource,\n            legacyEventType: `providers/cloud.firestore/eventTypes/${eventType}`,\n            dataConstructor,\n            options: this.options,\n        });\n    }\n}\nexports.DocumentBuilder = DocumentBuilder;\n"]},"metadata":{},"sourceType":"script"}